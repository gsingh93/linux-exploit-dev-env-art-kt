ART_KT_DIR := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))/art-kernel-toolkit

ART_KT_MAKE := \
  PATH=$(CLANG_DIR)/bin:$(PATH) \
  KERNEL_SRC=$(LINUX_OUT) \
  $(MAKE) -C $(ART_KT_DIR) \
  CC=clang \
  LLVM=1 LLVM_IAS=1 \
  ARCH=$(ARCH) \
  CROSS_COMPILE=$(TARGET)-

.PHONY: art-kt_help
art-kt_help:
	@echo '$(GREEN)Environment Variables:$(NC)'
	@echo '   ART_TEST_NO_QUIT                 - Set to 1 to leave QEMU running after the test script has completed (default: 0)'
	@echo ''
	@echo '$(GREEN)Targets:$(NC)'
	@echo '   art-kt                           - Build art-kernel-toolkit.ko, install the module into the kernel'\''s modules directory, and copy the module to the shared directory'
	@echo '   art-kt_help                      - Show this help message'
	@echo '   art-kt_clean                     - Clean the art-kernel-toolkit build'
	@echo '   art-kt_test                      - Run the art-kernel-toolkit test script'
	@echo '   art-kt_test_attach               - Attach to the serial port, assuming `art-kt_test` was run with with `ART_TEST_NO_QUIT=1`'
	@echo '   art-kt_test_attach_monitor       - Attach to the monitor port, assuming `art-kt_test` was run with with `ART_TEST_NO_QUIT=1`'
	@echo '   art-kt_test_quit                 - Quit the QEMU instance, assuming `art-kt_test` was run with with `ART_TEST_NO_QUIT=1`'

.PHONY: art-kt
art-kt: | $(SHARED_DIR) $(CLANG_DIR)
	$(ART_KT_MAKE) INSTALL_MOD_PATH=$(LINUX_MODULES_INSTALL_PATH) modules_install
	cp $(ART_KT_DIR)/art-kernel-toolkit.ko $(SHARED_DIR)

.PHONY: art-kt_clean
art-kt_clean:
	$(ART_KT_MAKE) clean

ART_TEST_NO_QUIT ?= 0

ART_TEST_SERIAL_PORT := 4321
ART_TEST_MONITOR_PORT := 4322

.PHONY: art-kt_test
art-kt_test: art-kt
	cp $(ART_KT_DIR)/test.sh $(SHARED_DIR)
	QEMU_EXTRA_ARGS="-serial tcp:localhost:$(ART_TEST_SERIAL_PORT),server,nowait -monitor tcp:localhost:$(ART_TEST_MONITOR_PORT),server,nowait" \
		QEMU_EXTRA_KERNEL_CMDLINE=art-kt-qemu-test \
		$(MAKE) run &

	sleep 3

	nc -w 1 localhost $(ART_TEST_SERIAL_PORT)
	echo "modprobe art-kernel-toolkit" | nc -w 1 localhost $(ART_TEST_SERIAL_PORT)
	echo /shared/test.sh | nc -w 1 localhost $(ART_TEST_SERIAL_PORT)

ifeq ($(ART_TEST_NO_QUIT),1)
	@echo ''
	@echo "$(GREEN)Leaving QEMU running, attach with 'make art-kt_test_attach'. Attach to monitor with 'make art-kt_test_attach_monitor'. Quit with 'make art-kt_test_quit'.$(NC)"
else
	echo quit | nc localhost $(ART_TEST_MONITOR_PORT)
endif

.PHONY: art-kt_test_attach
art-kt_test_attach:
	nc localhost $(ART_TEST_SERIAL_PORT)

.PHONY: art-kt_test_attach_monitor
art-kt_test_attach_monitor:
	nc localhost $(ART_TEST_MONITOR_PORT)

.PHONY: art-kt_test_quit
art-kt_test_quit:
	echo quit | nc localhost $(ART_TEST_MONITOR_PORT)
